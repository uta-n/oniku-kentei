<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ãŠè‚‰æ¤œå®šã‚¯ã‚¤ã‚º</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #fff0f0;
  color: #333;
  text-align: center;
  padding: 20px;
}
.hidden { display: none; }
button {
  background: #ff6666;
  color: white;
  border: none;
  padding: 12px 24px;
  margin: 8px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1rem;
}
button:hover { background: #ff3333; }
#quiz-container { margin-top: 20px; }
.choice { display: block; margin: 8px auto; width: 80%; max-width: 400px; text-align: center; }
#mode-screen button { display: block; width: 200px; margin: 10px auto; }
#result-screen h2 { font-size: 2rem; }
#share-buttons button { margin: 5px; }
</style>
</head>
<body>
<h1>ãŠè‚‰æ¤œå®šã‚¯ã‚¤ã‚º</h1>

<!-- åå‰å…¥åŠ›ç”»é¢ -->
<div id="name-screen">
  <p>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š</p>
  <input type="text" id="nickname" placeholder="ä¾‹: ãŠè‚‰å¤ªéƒ">
  <br>
  <button onclick="goToModeSelect()">æ¬¡ã¸</button>
</div>

<!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ -->
<div id="mode-screen" class="hidden">
  <h2>ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
  <button onclick="startGame(20)">20å•ãƒ¢ãƒ¼ãƒ‰</button>
  <button onclick="startGame(30)">30å•ãƒ¢ãƒ¼ãƒ‰</button>
  <button onclick="startGame(50)">50å•ãƒ¢ãƒ¼ãƒ‰</button>
  <button onclick="startGame(100)">è©¦é¨“ãƒ¢ãƒ¼ãƒ‰ (100å•)</button>
</div>

<!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
<div id="quiz-container" class="hidden">
  <h2 id="question-text"></h2>
  <div id="choices"></div>
  <p id="progress"></p>
</div>

<!-- çµæœç”»é¢ -->
<div id="result-screen" class="hidden">
  <h2 id="result-title"></h2>
  <p id="score-text"></p>
  <button onclick="location.reload()">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
  <div id="share-buttons">
    <button onclick="shareURL()">ğŸ”— URLã‚³ãƒ”ãƒ¼</button>
    <button onclick="shareLINE()">ğŸ’¬ LINE</button>
    <button onclick="shareX()">ğŸ¦ X</button>
  </div>
</div>

<script>
const SHEET_URL = "YOUR_SCRIPT_URL_HERE"; // â†Google Apps Scriptã®URL
let allQuestions = [];
let selectedQuestions = [];
let currentQuestionIndex = 0;
let score = 0;
let playerName = "";
let totalQuestions = 0;

// ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥å‰²åˆ
const categoryRatios = {
  1: 0.03,
  2: 0.18,
  3: 0.18,
  4: 0.12,
  5: 0.21,
  6: 0.21,
  7: 0.07
};

function goToModeSelect() {
  const nameInput = document.getElementById("nickname").value.trim();
  if (!nameInput) { alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  playerName = nameInput;
  document.getElementById("name-screen").classList.add("hidden");
  document.getElementById("mode-screen").classList.remove("hidden");
}

async function startGame(numQuestions) {
  totalQuestions = numQuestions;
  document.getElementById("mode-screen").classList.add("hidden");
  document.getElementById("quiz-container").classList.remove("hidden");

  const res = await fetch(SHEET_URL);
  allQuestions = await res.json();

  // ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ã«åˆ†ã‘ã‚‹
  let categorized = {};
  allQuestions.forEach(q => {
    if (!categorized[q.category]) categorized[q.category] = [];
    q.choices = q.choices.split(",");
    categorized[q.category].push(q);
  });

  // å‰²åˆã«å¿œã˜ã¦æŠ½å‡º
  selectedQuestions = [];
  Object.keys(categoryRatios).forEach(cat => {
    let count = Math.round(totalQuestions * categoryRatios[cat]);
    let pool = shuffleArray(categorized[cat] || []);
    selectedQuestions.push(...pool.slice(0, count));
  });

  while (selectedQuestions.length < totalQuestions) {
    let extra = allQuestions[Math.floor(Math.random() * allQuestions.length)];
    if (!selectedQuestions.includes(extra)) selectedQuestions.push(extra);
  }
  if (selectedQuestions.length > totalQuestions) selectedQuestions = selectedQuestions.slice(0, totalQuestions);

  selectedQuestions = shuffleArray(selectedQuestions);
  showQuestion();
}

function showQuestion() {
  if (currentQuestionIndex >= selectedQuestions.length) { endGame(); return; }

  let q = selectedQuestions[currentQuestionIndex];
  document.getElementById("question-text").textContent = q.question;
  let choicesDiv = document.getElementById("choices");
  choicesDiv.innerHTML = "";

  q.choices.forEach((choice, i) => {
    let btn = document.createElement("button");
    btn.textContent = choice;
    btn.className = "choice";
    btn.onclick = () => selectAnswer(i + 1, q.answer);
    choicesDiv.appendChild(btn);
  });

  document.getElementById("progress").textContent =
    `å•é¡Œ ${currentQuestionIndex + 1} / ${selectedQuestions.length}`;
}

function selectAnswer(selected, correct) {
  if (selected == correct) score++;
  currentQuestionIndex++;
  showQuestion();
}

function endGame() {
  document.getElementById("quiz-container").classList.add("hidden");
  document.getElementById("result-screen").classList.remove("hidden");

  const percent = Math.round(score / selectedQuestions.length * 100);
  const resultTitle = percent >= 80 ? "ğŸ‰ åˆæ ¼ï¼ãŠè‚‰ãƒã‚¹ã‚¿ãƒ¼ï¼" : "âŒ ä¸åˆæ ¼";
  document.getElementById("result-title").textContent = resultTitle;
  document.getElementById("score-text").textContent =
    `${playerName}ã•ã‚“ã®ã‚¹ã‚³ã‚¢ã¯ ${score} / ${selectedQuestions.length} (${percent}%) ã§ã™ï¼`;
}

// ã‚·ã‚§ã‚¢
function shareURL() {
  navigator.clipboard.writeText(location.href)
    .then(() => alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"))
    .catch(() => alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ"));
}

function shareLINE() {
  const text = `ç§ã¯${score}ç‚¹ã§ã—ãŸï¼ã‚ãªãŸã¯ãŠè‚‰ã«ã¤ã„ã¦ã©ã“ã¾ã§çŸ¥ã£ã¦ã‚‹ï¼Ÿ`;
  const url = location.href;
  const shareURL = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(url + '?message=' + text)}`;
  window.open(shareURL, "_blank");
}

function shareX() {
  const text = `ç§ã¯${score}ç‚¹ã§ã—ãŸï¼ã‚ãªãŸã¯ãŠè‚‰ã«ã¤ã„ã¦ã©ã“ã¾ã§çŸ¥ã£ã¦ã‚‹ï¼Ÿ`;
  const url = location.href;
  const shareURL = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
  window.open(shareURL, "_blank");
}

// ã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢æ•°
function shuffleArray(array) {
  let arr = array.slice();
  for (let i = arr.length-1; i>0; i--) {
    let j = Math.floor(Math.random() * (i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
</script>
</body>
</html>
